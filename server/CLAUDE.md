# Server (Go Backend)

The Go backend implements the CalDAV/CardDAV server, REST API, and protocol handlers. It follows **Clean Architecture** principles with strict dependency rules between layers.

## Directory Structure

```
server/
├── cmd/server/          # Application entrypoint (main.go)
├── configs/             # Configuration examples (config.yaml.example)
├── docs/                # Swagger/OpenAPI (auto-generated by swag)
│   ├── embed.go         # Embeds swagger.json/yaml into the binary
│   └── dav/             # DAV protocol documentation
├── internal/            # Core application code (see AGENT.md files below)
│   ├── config/          # Configuration loading (env vars + YAML)
│   ├── domain/          # Domain models, repository interfaces (zero dependencies)
│   ├── usecase/         # Business logic (depends only on domain)
│   ├── adapter/         # HTTP handlers, repositories, auth, WebDAV (depends on domain + usecase)
│   └── infrastructure/  # Database, server, email, logging (outermost layer)
├── scripts/             # Helper scripts
│   ├── build.sh         # Build binary to bin/server
│   └── test.sh          # Run tests
├── Dockerfile           # Multi-stage Alpine build (static binary)
├── docker-compose.yml   # SQLite deployment
└── docker-compose.postgres.yml  # PostgreSQL deployment
```

## Startup Sequence

The entrypoint (`cmd/server/main.go`) follows this sequence:

1. Load configuration from environment variables and `config.yaml`.
2. Validate configuration.
3. Initialize database connection (SQLite or PostgreSQL via GORM).
4. Handle CLI commands (e.g., `./server migrate` for manual migrations).
5. Auto-migrate database schema if `database.auto_migrate` is enabled.
6. Initialize Fiber server, register routes (dependency injection happens in `infrastructure/server/routes.go`), and start listening.

## API Surface

The server exposes two types of endpoints:

### REST API (`/api/v1/...`)

JSON API for the web frontend. Most responses are wrapped in `{ "status": "ok", "data": ... }` via `SuccessResponse()`.

| Area | Endpoints |
|------|-----------|
| Auth | Login, register, verify, refresh, logout, forgot/reset password |
| OAuth | Initiate, callback, link/unlink providers |
| SAML | Login, metadata |
| System | Settings (admin configured, SMTP enabled, registration enabled), auth methods |
| User | Get/update profile, delete account |
| Calendars | CRUD, public sharing, export |
| Events | CRUD, move between calendars |
| Address Books | CRUD, export |
| Contacts | CRUD, search, move, photo |
| Sharing | Calendar and address book share CRUD |
| Credentials | App passwords, CalDAV/CardDAV credentials |
| Import/Export | Calendar import (.ics), contact import (.vcf), full backup export |
| Docs | Swagger UI at `/docs`, JSON/YAML specs |
| Health | `GET /health` |

**Exception**: AddressBook and Contact endpoints return raw JSON (not wrapped in `SuccessResponse`).

### CalDAV/CardDAV (`/dav/...`)

WebDAV protocol endpoints for native calendar/contact client sync (Apple Calendar, Thunderbird, DAVx5, etc.). Uses HTTP Basic Auth with app passwords or DAV credentials.

## Context Files

Each `internal/` subdirectory has its own AGENT.md with detailed file listings:

- `internal/AGENT.md` — Architecture overview and request flow
- `internal/domain/AGENT.md` — Domain models and interfaces
- `internal/usecase/AGENT.md` — Business logic (auth, calendar, event, contact, sharing, import/export)
- `internal/usecase/auth/AGENT.md` — Authentication use cases (local, OAuth, SAML)
- `internal/adapter/AGENT.md` — HTTP handlers, repositories, auth implementations, WebDAV
- `internal/infrastructure/AGENT.md` — Database, server, email, logging

## Development

```bash
go build ./...              # Build
go test ./...               # Run all tests
go run ./cmd/server         # Run dev server
./scripts/build.sh          # Build binary to bin/server

# Swagger docs (requires swag)
swag init -g cmd/server/main.go --parseDependency --parseInternal
```

## Key Conventions

- **Configuration**: Loaded from environment variables (`CALDAV_*`) and/or `config.yaml`. See `configs/config.yaml.example`.
- **Database**: SQLite by default (zero config), PostgreSQL when `CALDAV_DB_HOST` is set.
- **Migrations**: GORM `AutoMigrate` — all models registered in `infrastructure/database/migrations.go`.
- **Auth**: JWT for REST API, HTTP Basic Auth for DAV endpoints. Backend uses `expires_at` (Unix timestamp) for JWT expiry.
- **SMTP**: When `cfg.SMTP.Host == ""` (SMTP not configured), users are auto-activated on registration.
- **WebDAV methods**: Custom HTTP methods (PROPFIND, REPORT, MKCALENDAR, etc.) registered in `infrastructure/server/server.go`.
- **Dependency injection**: All wiring happens in `infrastructure/server/routes.go`.
